<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Yapper â€“ Local Chat</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    input,
    button {
      margin: 6px 0;
      padding: 6px;
    }

    #rooms button {
      display: block;
      margin: 5px 0;
    }

    #chat {
      border: 1px solid #ccc;
      height: 260px;
      padding: 10px;
      overflow-y: auto;
      background: #f9f9f9;
      margin-bottom: 10px;
    }

    .msg {
      margin-bottom: 4px;
    }

    .system {
      color: gray;
      font-style: italic;
    }
  </style>
</head>

<body>

  <h2>ğŸ” Login</h2>
  <input id="username" placeholder="Username" />
  <input id="password" type="password" placeholder="Password" />
  <button type="button" onclick="login()">Login</button>

  <hr>

  <h2>ğŸ“ Location</h2>

  <label>
    Latitude:
    <input id="lat" type="number" step="any" value="28.6139">
  </label><br>

  <label>
    Longitude:
    <input id="lon" type="number" step="any" value="77.2090">
  </label><br>

  <button type="button" onclick="createRoom()">Create Room</button>
  <button type="button" onclick="findRooms()">Find Nearby Rooms</button>

  <hr>

  <h2>ğŸ  Nearby Rooms</h2>
  <div id="rooms"></div>

  <hr>

  <h2>ğŸ’¬ Chat</h2>
  <div id="chat"></div>

  <input id="msg" type="text" placeholder="Type message and press Enterâ€¦" />
  <button type="button" onclick="sendMessage()">Send</button>

  <script>
    /* ================= GLOBAL SAFETY ================= */
    document.addEventListener("submit", e => e.preventDefault(), true);
    /* ================================================= */

    const API = "http://127.0.0.1:8000";

    let ws = null;
    let currentRoom = null;
    let jwtToken = null;

    /* -------------------- UI -------------------- */

    function logChat(text, cls = "msg") {
      const chat = document.getElementById("chat");
      const line = document.createElement("div");
      line.className = cls;
      line.innerHTML = text;
      chat.appendChild(line);
      chat.scrollTop = chat.scrollHeight;
    }

    /* -------------------- AUTH -------------------- */

    async function login() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();

      if (!username || !password) {
        alert("Enter username and password");
        return;
      }

      const res = await fetch(`${API}/auth/login`, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({
          username,
          password
        })
      });

      if (!res.ok) {
        const err = await res.json();
        alert("Login failed: " + (err.detail || "unknown error"));
        return;
      }

      const data = await res.json();

      jwtToken = data.access_token;

      console.log("JWT TOKEN:", jwtToken); // ğŸ” DEBUG
      alert("Login successful!");
    }



    /* -------------------- API -------------------- */

    async function createRoom() {
      if (!jwtToken) {
        alert("Login first");
        return;
      }

      const lat = document.getElementById("lat").value;
      const lon = document.getElementById("lon").value;

      const res = await fetch(
        `${API}/rooms/create?lat=${lat}&lon=${lon}`,
        {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + jwtToken
          }
        }
      );

      if (!res.ok) {
        const err = await res.json();
        alert("Create room failed: " + JSON.stringify(err));
        return;
      }

      const room = await res.json();
      alert("Room created: " + room.id);
    }


    /* -------------------- WEBSOCKET -------------------- */

    function joinRoom(roomId) {
      if (!jwtToken) {
        alert("Login first");
        return;
      }

      if (ws && ws.readyState === WebSocket.OPEN) {
        return; // already connected
      }

      currentRoom = roomId;
      document.getElementById("chat").innerHTML = "";
      logChat("Joining room " + roomId + "...", "system");

      ws = new WebSocket(`ws://127.0.0.1:8000/ws/${roomId}`);

      ws.onopen = () => {
        logChat("Connected âœ…", "system");

        ws.send(JSON.stringify({
          action: "join",
          token: jwtToken,
          lat: parseFloat(document.getElementById("lat").value),
          lon: parseFloat(document.getElementById("lon").value)
        }));
      };

      ws.onmessage = (e) => {
        let data;
        try {
          data = JSON.parse(e.data);
        } catch {
          return;
        }

        if (data.error) {
          logChat("âŒ " + data.error, "system");
          return;
        }

        if (data.user && data.content) {
          logChat(`<b>${data.user}</b>: ${data.content}`);
        }
      };

      ws.onclose = () => {
        logChat("Disconnected âŒ", "system");
        ws = null;
      };
    }

    /* -------------------- SEND MESSAGE -------------------- */

    function sendMessage() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;

      const input = document.getElementById("msg");
      const msg = input.value.trim();
      if (!msg) return;

      input.value = "";

      ws.send(JSON.stringify({
        type: "text",
        content: msg
      }));
    }

    /* --------- ENTER KEY --------- */
    document.getElementById("msg").addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });


    async function findRooms() {
      const lat = document.getElementById("lat").value;
      const lon = document.getElementById("lon").value;

      const res = await fetch(
        `${API}/rooms/nearby?lat=${lat}&lon=${lon}`
      );

      if (!res.ok) {
        alert("Failed to fetch nearby rooms");
        return;
      }

      const rooms = await res.json();

      const container = document.getElementById("rooms");
      container.innerHTML = "";

      if (!rooms.length) {
        container.innerHTML = "<i>No nearby rooms found</i>";
        return;
      }

      rooms.forEach(room => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = "Join Room " + room.id;
        btn.onclick = () => joinRoom(room.id);
        container.appendChild(btn);
      });
    }

  </script>

</body>

</html>